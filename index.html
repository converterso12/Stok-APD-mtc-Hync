<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard APD</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChh_Qnw72udJXcqK1chCjASBm4ayMamuE",
            authDomain: "data-apd-hync.firebaseapp.com",
            databaseURL: "https://data-apd-hync-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "data-apd-hync",
            storageBucket: "data-apd-hync.appspot.com",
            messagingSenderId: "903552696891",
            appId: "1:903552696891:web:3dbd1ba665cad5fe1c121e",
            measurementId: "G-HGLFVBC0YD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tableBody = document.getElementById("apd-table-body");

        // Load APD data from Firebase
        function loadAPD() {
            get(ref(db, "APD")).then((snapshot) => {
                if (snapshot.exists()) {
                    tableBody.innerHTML = "";
                    let nomorUrut = 1;

                    snapshot.forEach((child) => {
                        let data = child.val();
                        let row = document.createElement("tr");

                        let nomorCell = document.createElement("td");
                        nomorCell.textContent = nomorUrut++;
                        row.appendChild(nomorCell);

                        let nameCell = document.createElement("td");
                        nameCell.textContent = data.nama + " (" + (data.namaMandarin || "未翻译") + ")";
                        row.appendChild(nameCell);

                        let stockCell = document.createElement("td");
                        stockCell.textContent = data.stok;
                        row.appendChild(stockCell);

                        let actionCell = document.createElement("td");
                        let historyButton = document.createElement("button");
                        historyButton.textContent = "Lihat (历史)";
                        historyButton.onclick = function () {
                            window.location.href = "history.html?id=" + child.key;
                        };
                        actionCell.appendChild(historyButton);
                        row.appendChild(actionCell);

                        tableBody.appendChild(row);
                    });
                }
            });
        }

        window.onload = loadAPD;
        

      function exportToExcel() {
    let tableBody = document.getElementById("apd-table-body");
    if (!tableBody) {
        alert("Data tabel tidak ditemukan!");
        return;
    }

    let data = [];

    // Tambahkan header dengan styling
    let header = ["No", "Nama APD", "Stok"];
    data.push(header);

    let rows = tableBody.getElementsByTagName("tr");
    if (rows.length === 0) {
        alert("Tidak ada data untuk diekspor!");
        return;
    }

    // Ambil data dari tabel
    for (let i = 0; i < rows.length; i++) {
        let cells = rows[i].getElementsByTagName("td");
        if (cells.length >= 3) {
            data.push([
                cells[0].innerText, // No
                cells[1].innerText, // Nama APD + Mandarin
                cells[2].innerText  // Stok
            ]);
        }
    }

    let ws = XLSX.utils.aoa_to_sheet(data);

    // Atur lebar kolom otomatis
    ws['!cols'] = [
        { wch: 5 },   // Kolom "No"
        { wch: 30 },   // Kolom "Nama APD"
        { wch: 10 }    // Kolom "Stok"
    ];

    // Terapkan wrap text pada Nama APD
    for (let i = 1; i <= rows.length; i++) {
        ws[`B${i + 1}`].s = { alignment: { wrapText: true } };
    }

    // Tambahkan warna pada header
    let headerStyle = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "4F81BD" } }, // Warna biru tua
        alignment: { horizontal: "center" }
    };

    let range = XLSX.utils.decode_range(ws["!ref"]);
    for (let C = range.s.c; C <= range.e.c; C++) {
        let cell = XLSX.utils.encode_cell({ r: 0, c: C });
        ws[cell].s = headerStyle;
    }

    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan Stok APD");

    // Simpan sebagai file Excel
    XLSX.writeFile(wb, "Laporan_Stok_APD.xlsx");
}

window.exportToExcel = exportToExcel;
    </script>
</head>
<body>
    <div class="container">
        <h1>Daftar APD MTC (个人防护装备清单)</h1>
        <table border="1">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama APD (个人防护装备名称)</th>
                    <th>Stok (库存)</th>
                    <th>Histori (历史)</th>
                </tr>
            </thead>
            <tbody id="apd-table-body">
                <!-- Data dari Firebase -->
            </tbody>
        </table>
        
   <button class="tambah" onclick="cekKode('tambah-apd.html')">Tambah APD</button>
<button class="masuk" onclick="cekKode('barang-masuk.html')">Barang Masuk</button>
<button class="keluar" onclick="cekKode('barang-keluar.html')">Barang Keluar</button>

<script>
        function cekKode(url) {
            let kode = prompt("Masukkan kode akses:");
            if (kode === "00") {
                window.location.href = url;
            } else {
                alert("Kode salah! Akses ditolak.");
            }
        }
    </script>

    <button class="export" onclick="exportToExcel()">Export ke Excel</button>
    </div>
</body>
</html>