<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barang Masuk - Tambah Stok</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyChh_Qnw72udJXcqK1chCjASBm4ayMamuE",
            authDomain: "data-apd-hync.firebaseapp.com",
            databaseURL: "https://data-apd-hync-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "data-apd-hync",
            storageBucket: "data-apd-hync.appspot.com",
            messagingSenderId: "903552696891",
            appId: "1:903552696891:web:3dbd1ba665cad5fe1c121e",
            measurementId: "G-HGLFVBC0YD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const apdSelect = document.getElementById("apd-select");

        function loadAPD() {
            get(ref(db, "APD")).then((snapshot) => {
                if (snapshot.exists()) {
                    apdSelect.innerHTML = "<option value=''>Pilih APD</option>";
                    snapshot.forEach((child) => {
                        let data = child.val();
                        let option = document.createElement("option");
                        option.value = child.key;
                        option.textContent = data.nama;
                        apdSelect.appendChild(option);
                    });
                }
            });
        }

        window.tambahStok = function () {
            const apdKey = apdSelect.value;
            const tambahan = parseInt(document.getElementById("jumlah").value);

            if (apdKey === "" || isNaN(tambahan) || tambahan <= 0) {
                alert("Harap pilih APD dan masukkan jumlah yang valid!");
                return;
            }

            const apdRef = ref(db, "APD/" + apdKey);
            get(apdRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const newStock = (data.stok || 0) + tambahan;
                    
                    // Buat key baru untuk history
                    const historyKey = push(ref(db, `APD/${apdKey}/history`)).key;

                    // Data history dalam format yang diinginkan
                    const historyData = {
                        tanggal: new Date().toISOString().split('T')[0], // Format YYYY-MM-DD
                        jumlah: tambahan,
                        jenis: "masuk"
                    };

                    // Update stok + tambah history langsung di dalam APD
                    const updates = {};
                    updates[`APD/${apdKey}/stok`] = newStock;
                    updates[`APD/${apdKey}/history/${historyKey}`] = historyData;

                    update(ref(db), updates).then(() => {
                        alert("Stok berhasil ditambahkan!");
                        document.getElementById("jumlah").value = "";
                    }).catch(error => {
                        alert("Gagal menyimpan: " + error);
                    });
                }
            });
        };

        window.onload = loadAPD;
    </script>
</head>
<body>
    <div class="container">
        <h1>Barang Masuk - Tambah Stok</h1>
        <select id="apd-select"></select>
        <input type="number" id="jumlah" placeholder="Jumlah Tambah">
        <button onclick="tambahStok()">Tambah Stok</button>
        <button onclick="window.location.href='index.html'">Kembali</button>
    </div>
</body>
</html>